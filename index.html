<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Suomen liputusp√§iv√§t</title>
<link href="tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold text-center mb-6">
  Suomen liputusp√§iv√§t <span id="year"></span>
</h1>

<p class="text-center mb-6 text-sm space-y-1">
  <a href="#" onclick="downloadICS(0); return false;"
     class="block text-blue-800 hover:underline">
    Lataa liputusp√§iv√§t 2026 kalenteriisi (.ics)
  </a>

  <a href="#" onclick="downloadICS(25); return false;"
     class="block text-blue-800 hover:underline">
    Lataa liputusp√§iv√§t 2026 + 25 vuotta kalenteriisi (.ics)
  </a>

  <a href="#" onclick="downloadICS(50); return false;"
     class="block text-blue-800 hover:underline">
    Lataa liputusp√§iv√§t 2026 + 50 vuotta kalenteriisi (.ics)
  </a>

  <a href="#" onclick="downloadICS(100); return false;"
     class="block text-blue-800 hover:underline">
    Lataa liputusp√§iv√§t 2026 + 100 vuotta kalenteriisi (.ics)
  </a>
</p>

<noscript class="text-red-600 text-sm flex justify-center">
  T√§m√§ kalenteri vaatii JavaScriptin toimiakseen.
</noscript>

<table id="calendar" class="table-fixed w-full border-collapse text-sm text-center"></table>

<p class="text-sm flex justify-center mt-6">Tekij√§: Jukka Pajarinen</p>
<p class="text-sm flex flex-col items-center">
  <a class="text-blue-800 hover:underline" href="https://www.jukkapajarinen.com" target="_blank">www.jukkapajarinen.com</a>
  <a class="text-blue-800 hover:underline" href="https://www.lumitum.com" target="_blank">www.lumitum.com</a>
</p>

<script>
const calendar = document.getElementById("calendar");

// Create the thead
const thead = document.createElement("thead");
thead.className = "bg-gray-300";

const headRow = document.createElement("tr");
["Viikko","Ma","Ti","Ke","To","Pe","La","Su"].forEach((day, i) => {
  const th = document.createElement("th");
  th.className = `border border-gray-400 ${i===0?'w-14':''} bg-gray-300 ${i>=6?'text-red-600':''}`;
  th.textContent = day;
  headRow.appendChild(th);
});
thead.appendChild(headRow);
calendar.appendChild(thead);

// Create tbody
const tbody = document.createElement("tbody");
tbody.id = "calendar-body";
calendar.appendChild(tbody);

const today = new Date();
today.setHours(0, 0, 0, 0);


const year = today.getFullYear();
document.getElementById("year").textContent = year;

/* ---------- HELPERS ---------- */
const getWeekNumber = date => {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
};

const nthSunday = (month, n) => {
  const d = new Date(year, month, 1);
  let count = 0;
  while (true) {
    if (d.getDay() === 0) count++;
    if (count === n) return new Date(d);
    d.setDate(d.getDate() + 1);
  }
};

const lastSaturday = month => {
  const d = new Date(year, month + 1, 0);
  while (d.getDay() !== 6) d.setDate(d.getDate() - 1);
  return new Date(d);
};

const midsummerDay = () => {
  for (let d = 20; d <= 26; d++) {
    const date = new Date(year, 5, d);
    if (date.getDay() === 6) return date;
  }
};

/* ---------- FLAG DAYS ---------- */
const flags = {}; // { "Fri Feb 28 2024": [{name, rule, category}] }

const addFlag = (date, name, rule, cat) => {
  const key = date.toDateString();
  if (!flags[key]) flags[key] = [];
  flags[key].push({ name, rule, category: cat });
};

// Official flag days
[
  [1, 28, "Kalevalan p√§iv√§", "28.2."],
  [4, 1, "Vappu", "1.5."],
  [5, 4, "Puolustusvoimain lippujuhlan p√§iv√§", "4.6."],
  [5, 0, "Juhannusp√§iv√§ ‚Äì Suomen lipun p√§iv√§", "Kes√§kuun 20.‚Äì26. lauantai"],
  [10, 0, "Is√§np√§iv√§", "Marraskuun toinen sunnuntai"],
  [4, 0, "√Ñitienp√§iv√§", "Toukokuun toinen sunnuntai"],
  [11, 6, "Itsen√§isyysp√§iv√§", "6.12."]
].forEach(([m, d, name, rule]) => {
  let date;
  if (d === 0 && name === "Juhannusp√§iv√§ ‚Äì Suomen lipun p√§iv√§") date = midsummerDay();
  else if (d === 0 && name === "√Ñitienp√§iv√§") date = nthSunday(4, 2);
  else if (d === 0 && name === "Is√§np√§iv√§") date = nthSunday(10, 2);
  else date = new Date(year, m, d);
  addFlag(date, name, rule, "virallinen");
});

// Established flag days
[
  [1, 5, "J. L. Runebergin p√§iv√§", "5.2."],
  [2, 19, "Minna Canthin p√§iv√§", "19.3."],
  [3, 9, "Mikael Agricolan p√§iv√§", "9.4."],
  [3, 27, "Kansallinen veteraanip√§iv√§", "27.4."],
  [4, 9, "Eurooppa-p√§iv√§", "9.5."],
  [4, 12, "J. V. Snellmanin p√§iv√§", "12.5."],
  [4, 0, "Kaatuneitten muistop√§iv√§", "Toukokuun kolmas sunnuntai"],
  [6, 6, "Eino Leinon p√§iv√§", "6.7."],
  [7, 0, "Suomen luonnon p√§iv√§", "Elokuun viimeinen lauantai"],
  [9, 1, "Miina Sillanp√§√§n p√§iv√§", "1.10."],
  [9, 10, "Aleksis Kiven p√§iv√§", "10.10."],
  [9, 24, "YK:n p√§iv√§", "24.10."],
  [10, 6, "Ruotsalaisuuden p√§iv√§", "6.11."],
  [10, 20, "Lapsen oikeuksien p√§iv√§", "20.11."],
  [11, 8, "Jean Sibeliuksen p√§iv√§", "8.12."]
].forEach(([m, d, name, rule]) => {
  let date;
  if (d === 0 && name === "Kaatuneitten muistop√§iv√§") date = nthSunday(4, 3);
  else if (d === 0 && name === "Suomen luonnon p√§iv√§") date = lastSaturday(7);
  else date = new Date(year, m, d);
  addFlag(date, name, rule, "vakiintunut");
});

/* ---------- CALENDAR ---------- */
let date = new Date(year, 0, 1);

// Move to the first Monday before the year's start
while (date.getDay() !== 1) date.setDate(date.getDate() - 1);

const monthBg = ["bg-white","bg-gray-200","bg-white","bg-gray-200","bg-white","bg-gray-200",
                 "bg-white","bg-gray-200","bg-white","bg-gray-200","bg-white","bg-gray-200"];

const monthNames = ["tammi","helmi","maalis","huhti","touko","kes√§",
                    "hein√§","elo","syys","loka","marras","joulu"];

let currentMonth = -1;

while (date.getFullYear() <= year) {
  if (date.getMonth() !== currentMonth) currentMonth = date.getMonth();

  const tr = document.createElement("tr");

  // Week number
  const weekTd = document.createElement("td");
  weekTd.textContent = getWeekNumber(date);
  weekTd.className = "border border-gray-400 text-gray-700 bg-gray-300";
  tr.appendChild(weekTd);

  for (let i = 0; i < 7; i++) {
    const td = document.createElement("td");
    td.className = "border border-gray-400 align-top";

    if (date.getFullYear() === year) {
      // Day number and month name
      let dayText = date.getDate();
      if (dayText === 1) dayText += `.${monthNames[date.getMonth()]}`;
      td.innerHTML = `<div class="day font-semibold">${dayText}</div>`;

      // Background color
      td.classList.add(monthBg[date.getMonth()]);

      // Past days
      if (date < today) td.classList.add("text-gray-400", "line-through");

      // Flag days
      const dayFlags = flags[date.toDateString()];
      if (dayFlags) {
        // If any flag is "virallinen", the cell is bg-blue-300
        const isOfficial = dayFlags.some(f => f.category === "virallinen");
        td.classList.remove("bg-white", "bg-gray-200");
        td.classList.add(isOfficial ? "bg-blue-300" : "bg-blue-100");

        td.title = dayFlags.map(f => `${f.name} (${f.rule})`).join("\n");
        td.innerHTML += `<div class="text-xs text-blue-800">${dayFlags.map(f => f.name).join(", ")}</div>`;
      }

      // Today
      if (date.getTime() === today.getTime()) {
        const wasOfficial = dayFlags && dayFlags.some(f => f.category === "virallinen");
        td.classList.remove("bg-white", "bg-gray-200", "bg-blue-300", "bg-blue-100");
        td.classList.add(wasOfficial ? "bg-green-300" : "bg-green-100");
        
        // üá´üáÆ if today is a flag day
        if (dayFlags) {
          const dayDiv = td.querySelector(".day");
          dayDiv.textContent += " üá´üáÆ";
        }
      }
    } else {
      td.classList.add("bg-gray-100");
    }

    tr.appendChild(td);
    date.setDate(date.getDate() + 1);
  }

  tbody.appendChild(tr);
}
</script>

<script>
/* ===================================================================
   ======================  ICS EXPORT ===== ==========================
   =================================================================== */

function downloadICS(yearsAhead) {
  const startYear = year;
  const endYear = year + yearsAhead;

  /* ---- YEAR-AWARE HELPERS (ICS ONLY) ---- */
  const nthSundayY = (year, month, n) => {
    const d = new Date(year, month, 1);
    let count = 0;
    while (true) {
      if (d.getDay() === 0) count++;
      if (count === n) return new Date(d);
      d.setDate(d.getDate() + 1);
    }
  };

  const lastSaturdayY = (year, month) => {
    const d = new Date(year, month + 1, 0);
    while (d.getDay() !== 6) d.setDate(d.getDate() - 1);
    return new Date(d);
  };

  const midsummerDayY = year => {
    for (let d = 20; d <= 26; d++) {
      const date = new Date(year, 5, d);
      if (date.getDay() === 6) return date;
    }
  };

  let ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Jukka Pajarinen//Suomen liputusp√§iv√§t//FI
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

  const pad = n => String(n).padStart(2,"0");
  const ymd = d => `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;

  const addEvent = (d, name) => {
    const end = new Date(d);
    end.setDate(end.getDate() + 1); // proper all-day event

    ics +=
`BEGIN:VEVENT
UID:${name.replace(/\s+/g,"-").toLowerCase()}-${ymd(d)}@liputuspv
DTSTART;VALUE=DATE:${ymd(d)}
DTEND;VALUE=DATE:${ymd(end)}
SUMMARY:${name} üá´üáÆ
TRANSP:TRANSPARENT
END:VEVENT
`;
  };

  for (let y = startYear; y <= endYear; y++) {

    // Fixed-date flag days
    [
      [1,28,"Kalevalan p√§iv√§"],
      [4,1,"Vappu"],
      [5,4,"Puolustusvoimain lippujuhlan p√§iv√§"],
      [11,6,"Itsen√§isyysp√§iv√§"],
      [1,5,"J. L. Runebergin p√§iv√§"],
      [2,19,"Minna Canthin p√§iv√§"],
      [3,9,"Mikael Agricolan p√§iv√§"],
      [3,27,"Kansallinen veteraanip√§iv√§"],
      [4,9,"Eurooppa-p√§iv√§"],
      [4,12,"J. V. Snellmanin p√§iv√§"],
      [6,6,"Eino Leinon p√§iv√§"],
      [9,1,"Miina Sillanp√§√§n p√§iv√§"],
      [9,10,"Aleksis Kiven p√§iv√§"],
      [9,24,"YK:n p√§iv√§"],
      [10,6,"Ruotsalaisuuden p√§iv√§"],
      [10,20,"Lapsen oikeuksien p√§iv√§"],
      [11,8,"Jean Sibeliuksen p√§iv√§"]
    ].forEach(([m,d,n]) => addEvent(new Date(y,m,d), n));

    // Movable flag days (FIXED)
    addEvent(nthSundayY(y,4,2), "√Ñitienp√§iv√§");
    addEvent(nthSundayY(y,10,2), "Is√§np√§iv√§");
    addEvent(nthSundayY(y,4,3), "Kaatuneitten muistop√§iv√§");
    addEvent(lastSaturdayY(y,7), "Suomen luonnon p√§iv√§");
    addEvent(midsummerDayY(y), "Juhannusp√§iv√§ ‚Äì Suomen lipun p√§iv√§");
  }

  ics += "END:VCALENDAR";

  const blob = new Blob([ics], { type:"text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download =
    yearsAhead === 0
      ? `suomen-liputuspaivat-${startYear}.ics`
      : `suomen-liputuspaivat-${startYear}-${endYear}.ics`;

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
